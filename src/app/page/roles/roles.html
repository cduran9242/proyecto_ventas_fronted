<div class="roles-container">
  <div class="roles-header">
    <h1>Gesti√≥n de Roles y Permisos</h1>
    <p>Configura los roles del sistema y asigna los m√≥dulos y acciones que pueden realizar.</p>
  </div>

  <div class="nuevo-rol-section">
    <div class="form-header">
      <div>
        <h2>{{ modoEdicion ? 'Editar rol' : 'Registrar nuevo rol' }}</h2>
        <p>
          Define el rol y selecciona los m√≥dulos a los que tendr√° acceso.
        </p>
      </div>
      <div class="user-icon">üõ°Ô∏è</div>
    </div>

    <form class="rol-form" [formGroup]="rolForm" (ngSubmit)="guardarRol()">
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre">Nombre del rol</label>
          <input
            id="nombre"
            type="text"
            placeholder="Ej: Administrador, Facturador"
            formControlName="nombre"
            [class.error]="nombre?.invalid && (nombre?.dirty || nombre?.touched)"
          />
          <small *ngIf="nombre?.hasError('required') && (nombre?.dirty || nombre?.touched)">
            El nombre es obligatorio.
          </small>
          <small *ngIf="nombre?.hasError('maxlength') && (nombre?.dirty || nombre?.touched)">
            M√°ximo 100 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="estado">Estado</label>
          <select
            id="estado"
            formControlName="estado"
            [class.error]="estado?.invalid && (estado?.dirty || estado?.touched)"
          >
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="descripcion">Descripci√≥n</label>
        <textarea
          id="descripcion"
          rows="3"
          placeholder="Describe las responsabilidades o alcance de este rol"
          formControlName="descripcion"
          [class.error]="descripcion?.invalid && (descripcion?.dirty || descripcion?.touched)"
        ></textarea>
        <small *ngIf="descripcion?.hasError('maxlength') && (descripcion?.dirty || descripcion?.touched)">
          M√°ximo 255 caracteres.
        </small>
      </div>

      <section class="permisos-section">
        <header class="permisos-header">
          <h3>M√≥dulos disponibles</h3>
          <p>Selecciona los m√≥dulos y define los permisos por acci√≥n.</p>
        </header>

        <div class="permisos-grid" formArrayName="modulos">
          <div
            class="modulo-card"
            *ngFor="let moduloCtrl of modulosControles; let i = index"
            [formGroupName]="i"
          >
            <div class="modulo-header">
              <label>
                <input type="checkbox" formControlName="seleccionado" />
                <span>{{ moduloCtrl.get('nombre_modulo')?.value }}</span>
              </label>
              <span class="modulo-estado" [class.inactivo]="moduloCtrl.get('estado')?.value === 'Inactivo'">
                {{ moduloCtrl.get('estado')?.value }}
              </span>
            </div>

            <div class="modulo-permisos" *ngIf="moduloCtrl.get('seleccionado')?.value">
              <label>
                <input type="checkbox" formControlName="puede_ver" />
                Ver
              </label>
              <label>
                <input type="checkbox" formControlName="puede_crear" />
                Crear
              </label>
              <label>
                <input type="checkbox" formControlName="puede_editar" />
                Editar
              </label>
              <label>
                <input type="checkbox" formControlName="puede_eliminar" />
                Eliminar
              </label>
            </div>
          </div>
        </div>
      </section>

      <div class="form-actions">
        <button type="submit" class="btn-registrar" [disabled]="cargando">
          {{ modoEdicion ? 'üíæ Guardar cambios' : '‚úÖ Registrar rol' }}
        </button>
        <button type="button" class="btn-nuevo" (click)="modoEdicion ? cancelarEdicion() : resetFormulario()" [disabled]="cargando">
          {{ modoEdicion ? '‚Ü©Ô∏è Cancelar edici√≥n' : 'üßπ Limpiar' }}
        </button>
      </div>
    </form>

    <div class="feedback">
      <div class="alert success" *ngIf="mensajeExito">{{ mensajeExito }}</div>
      <div class="alert error" *ngIf="mensajeError">{{ mensajeError }}</div>
    </div>
  </div>

  <div class="roles-lista-section">
    <div class="lista-header">
      <h2>Roles configurados</h2>
      <button class="btn-refrescar" type="button" (click)="cargarRoles()" [disabled]="cargando">
        üîÑ Actualizar
      </button>
    </div>

    <div class="tabla-container">
      <table class="tabla-roles">
        <thead>
          <tr>
            <th>Rol</th>
            <th>Descripci√≥n</th>
            <th>M√≥dulos asignados</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="cargando">
            <td colspan="6" class="loading-row">Cargando roles...</td>
          </tr>

          <tr *ngIf="!cargando && roles.length === 0">
            <td colspan="6" class="empty-row">No hay roles registrados todav√≠a.</td>
          </tr>

          <tr *ngFor="let rol of roles" [class.selected]="rolSeleccionadoId === rol.id">
            <td class="perfil-nombre">{{ rol.nombre }}</td>
            <td class="descripcion-cell">{{ rol.descripcion || '‚Äî' }}</td>
            <td>
              <div class="permisos-badges">
                <span class="permiso-badge" *ngFor="let modulo of rol.modulos">
                  {{ modulo.nombre_modulo || ('M√≥dulo ' + modulo.modulo_id) }}
                  <small>({{ (modulo.permisos || []).join(', ') || 'ver' }})</small>
                </span>
              </div>
            </td>
            <td>
              <span class="estado-badge" [class.activo]="rol.estado === 'Activo'" [class.inactivo]="rol.estado !== 'Activo'">
                {{ rol.estado }}
              </span>
            </td>
            <td>{{ rol.created_at | date:'short' }}</td>
            <td>
              <button class="btn-editar" type="button" (click)="editarRol(rol)">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn-eliminar" type="button" (click)="eliminarRol(rol)">
                üóëÔ∏è Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

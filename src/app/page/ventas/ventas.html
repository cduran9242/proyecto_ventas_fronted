<div class="ventas-page">
  <header class="ventas-header">
    <div>
      <h1>üí∞ Gesti√≥n de Ventas</h1>
      <p>Registra, consulta y administra los pedidos con m√∫ltiples productos.</p>
    </div>
    <div class="ventas-meta">
      <label class="busqueda-label">
        <span>Buscar</span>
        <input
          type="search"
          placeholder="Cliente, estado, producto..."
          [formControl]="busquedaControl"
        >
      </label>
    </div>
  </header>

  <section class="alertas" *ngIf="mensajeError || mensajeExito">
    <div class="alerta error" *ngIf="mensajeError">{{ mensajeError }}</div>
    <div class="alerta exito" *ngIf="mensajeExito">{{ mensajeExito }}</div>
  </section>

  <section class="venta-form-card" [formGroup]="ventaForm">
    <div class="form-header">
      <h2>{{ modoEdicion ? '‚úèÔ∏è Editar pedido' : 'üõí Nuevo pedido' }}</h2>
      <span class="badge" [class.editando]="modoEdicion">{{ modoEdicion ? 'Edici√≥n' : 'Registro' }}</span>
    </div>

    <form (ngSubmit)="guardarVenta()">
      <div class="encabezado-grid">
        <label class="form-field">
          <span>Tipo de pedido</span>
          <input type="text" formControlName="tipo_pedido" placeholder="Nacional, Internacional...">
          <small class="error" *ngIf="tipoPedidoControl?.invalid && tipoPedidoControl?.touched">Ingresa el tipo de pedido.</small>
        </label>

        <label class="form-field">
          <span>ID Cliente</span>
          <input type="number" formControlName="id_cliente" placeholder="Identificador del cliente">
          <small class="error" *ngIf="clienteControl?.invalid && clienteControl?.touched">Ingresa el ID del cliente.</small>
        </label>

        <label class="form-field">
          <span>ID Vendedor</span>
          <input type="number" formControlName="id_vendedor" placeholder="Identificador del vendedor">
          <small class="error" *ngIf="vendedorControl?.invalid && vendedorControl?.touched">Ingresa el ID del vendedor.</small>
        </label>

        <label class="form-field">
          <span>Moneda</span>
          <select formControlName="moneda">
            <option *ngFor="let moneda of monedasDisponibles" [value]="moneda">{{ moneda }}</option>
          </select>
        </label>

        <label class="form-field">
          <span>TRM</span>
          <input type="number" formControlName="trm" min="0" step="0.0001">
        </label>

        <label class="form-field">
          <span>O.C. Cliente</span>
          <input type="text" formControlName="oc_cliente" placeholder="N√∫mero de orden de compra">
        </label>

        <label class="form-field">
          <span>Condici√≥n de pago</span>
          <input type="text" formControlName="condicion_pago" placeholder="Contado, Cr√©dito 30 d√≠as...">
        </label>
      </div>

      <div class="detalles-card" formArrayName="detalles">
        <div class="detalles-header">
          <h3>Productos del pedido</h3>
          <button
            type="button"
            class="btn-add"
            (click)="agregarDetalle()"
            [disabled]="detalles.disabled"
          >
            + Agregar producto
          </button>
        </div>

        <div class="detalles-table-scroll">
          <div class="detalles-table">
            <div class="detalle-row" *ngFor="let detalle of detalles.controls; let i = index" [formGroupName]="i">
              <span class="linea">{{ i + 1 }}</span>

              <label>
                <span>Producto</span>
                <select formControlName="id_producto">
                  <option value="">Seleccionar</option>
                  <option *ngFor="let producto of productos" [value]="producto.id">
                    {{ producto.nombre_producto || producto.nombre || ('Producto #' + producto.id) }}
                  </option>
                </select>
                <small class="error" *ngIf="detalle.get('id_producto')?.invalid && detalle.get('id_producto')?.touched">Requerido.</small>
              </label>

              <label>
                <span>Cantidad</span>
                <input type="number" formControlName="cantidad_solicitada" min="0.01" step="0.01">
              </label>

              <label>
                <span>Confirmada</span>
                <input type="number" formControlName="cantidad_confirmada" min="0" step="0.01">
              </label>

              <label>
                <span>Precio Unitario</span>
                <input type="number" formControlName="precio_unitario" min="0" step="0.01">
              </label>

              <label>
                <span>N¬∞ Documento</span>
                <input type="text" formControlName="numero_documento">
              </label>

              <label>
                <span>Tipo Documento</span>
                <input type="text" formControlName="tipo_documento">
              </label>

              <label>
                <span>Estado anterior</span>
                <input type="number" formControlName="estado_anterior" min="0">
              </label>

              <label>
                <span>Estado siguiente</span>
                <input type="number" formControlName="estado_siguiente" min="0">
              </label>

              <div class="detalle-total">
                <span>Total</span>
                <strong>{{ (detalle.get('cantidad_solicitada')?.value || 0) * (detalle.get('precio_unitario')?.value || 0) | number:'1.2-2' }}</strong>
              </div>

              <button
                type="button"
                class="btn-remove"
                (click)="eliminarDetalle(i)"
                [disabled]="detalles.disabled"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>

        <div class="resumen-venta">
          <span>Total pedido</span>
          <strong>{{ totalFormulario | number:'1.2-2' }}</strong>
        </div>
      </div>

      <div class="form-actions">
        <button
          type="submit"
          class="btn-primary"
          [disabled]="ventaForm.invalid || detalles.disabled || cargando"
        >
          {{ modoEdicion ? 'Guardar cambios' : 'Registrar pedido' }}
        </button>
        <button type="button" class="btn-secondary" (click)="modoEdicion ? cancelarEdicion() : limpiarFormulario()">
          {{ modoEdicion ? 'Cancelar' : 'Limpiar' }}
        </button>
      </div>
    </form>
  </section>

  <section class="ventas-listado">
    <header>
      <div>
        <h2>üìã Pedidos registrados</h2>
        <p *ngIf="ventasFiltradas.length !== ventas.length" class="filtros-activos">
          Mostrando {{ ventasFiltradas.length }} de {{ ventas.length }} pedidos
        </p>
      </div>
      <div class="header-actions">
        <button class="btn-refrescar" type="button" (click)="cargarVentas()" [disabled]="cargando">
          üîÑ {{ cargando ? 'Cargando...' : 'Actualizar' }}
        </button>
        <button type="button" class="btn-exportar" (click)="exportarCSV()" [disabled]="ventasFiltradas.length === 0">
          üì§ Exportar CSV
        </button>
      </div>
    </header>

    <div class="tabla-wrapper" *ngIf="ventasFiltradas.length; else sinResultados">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>Cliente</th>
            <th>Vendedor</th>
            <th>Moneda</th>
            <th>TRM</th>
            <th>Total</th>
            <th>Departamento</th>
            <th>Ciudad</th>
            <th>Registrado</th>
            <th class="acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let venta of ventasPaginadas">
            <tr>
              <td>{{ venta.id }}</td>
              <td>{{ venta.tipo_pedido }}</td>
              <td>{{ venta.id_cliente }}</td>
              <td>{{ venta.id_vendedor }}</td>
              <td>{{ venta.moneda }}</td>
              <td>{{ venta.trm | number:'1.2-2' }}</td>
              <td>{{ calcularTotalPedido(venta) | number:'1.2-2' }}</td>
              <td>
                <span class="ubicacion-badge">
                  {{obtenerNombreDepartamento(venta.departamento_id)}}
                </span>
              </td>
              <td>
                <span class="ubicacion-badge">
                  {{obtenerNombreCiudad(venta.ciudad_id)}}
                </span>
              </td>
              <td>{{ venta.created_at | date:'short' }}</td>
              <td class="acciones">
                <button class="btn-icon" type="button" (click)="toggleExpancion(venta.id)">
                  {{ pedidoExpandidoId === venta.id ? 'Ocultar' : 'Ver' }}
                </button>
                <button class="btn-icon" type="button" (click)="editarVenta(venta)" [disabled]="!permiteEditar">‚úèÔ∏è</button>
                <button class="btn-icon danger" type="button" (click)="anularVenta(venta)" [disabled]="!permiteEliminar">üóëÔ∏è</button>
              </td>
            </tr>
            <tr *ngIf="pedidoExpandidoId === venta.id" class="detalle-expandido">
              <td colspan="11">
                <table class="tabla-detalles">
                  <thead>
                    <tr>
                      <th>L√≠nea</th>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Confirmada</th>
                      <th>Precio</th>
                      <th>Total</th>
                      <th>Documento</th>
                      <th>Estados</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let det of venta.detalles">
                      <td>{{ det.numero_linea }}</td>
                      <td>{{ det.producto_nombre || det.id_producto }}</td>
                      <td>{{ det.cantidad_solicitada | number:'1.2-2' }}</td>
                      <td>{{ det.cantidad_confirmada | number:'1.2-2' }}</td>
                      <td>{{ det.precio_unitario | number:'1.2-2' }}</td>
                      <td>{{ det.precio_total || calcularTotalDetalle(det) | number:'1.2-2' }}</td>
                      <td>{{ det.tipo_documento }} {{ det.numero_documento }}</td>
                      <td>{{ det.estado_anterior }} ‚Üí {{ det.estado_siguiente }}</td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div class="paginacion-container" *ngIf="totalPaginas > 1">
        <div class="paginacion-info">
          <p>Mostrando {{ ventasPaginadas.length }} de {{ ventasFiltradas.length }} pedidos</p>
        </div>
        <div class="paginacion-controls">
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('prev')" 
            [disabled]="paginaActual === 1"
          >
            ¬´ Anterior
          </button>
          <div class="paginas-numeros">
            <button
              *ngFor="let pagina of [].constructor(totalPaginas); let i = index"
              type="button"
              class="btn-pagina-numero"
              [class.active]="paginaActual === i + 1"
              (click)="cambiarPagina(i + 1)"
            >
              {{ i + 1 }}
            </button>
          </div>
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('next')" 
            [disabled]="paginaActual === totalPaginas"
          >
            Siguiente ¬ª
          </button>
        </div>
        <div class="paginacion-info">
          <p>P√°gina {{ paginaActual }} de {{ totalPaginas }}</p>
        </div>
      </div>
    </div>

    <ng-template #sinResultados>
      <p class="sin-datos">No se encontraron pedidos.</p>
    </ng-template>
  </section>
</div>

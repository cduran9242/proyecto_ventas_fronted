<div class="reportes-container">
  <div class="reportes-header">
    <h1>Reportes y An√°lisis</h1>
    <p>Genera reportes detallados con diferentes par√°metros de b√∫squeda</p>
  </div>

  <section class="powerbi-section" *ngIf="puedeVerPowerBi; else sinPermisos">
    <div class="powerbi-header">
      <h2>Tablero Ejecutivo Power BI</h2>
      <p>Visualiza m√©tricas en tiempo real del proyecto de ventas</p>
    </div>
    <div class="powerbi-wrapper">
      <iframe
        title="Tablero Power BI - Proyecto Ventas"
        [src]="iframeUrl"
        width="100%"
        height="541.25"
        frameborder="0"
        allowFullScreen="true"
        loading="lazy"
      ></iframe>
    </div>
  </section>

  <ng-template #sinPermisos>
    <div class="powerbi-restricted">
      <h2>Acceso restringido</h2>
      <p>Este tablero solo est√° disponible para usuarios con rol Administrador.</p>
    </div>
  </ng-template>

  <!-- Formulario de filtros -->
  <div class="filtros-section">
    <h2>üîç Filtros de B√∫squeda</h2>
    <form class="filtros-form" (ngSubmit)="buscar()">
      <div class="filtros-grid">
        <div class="form-group">
          <label for="fechaInicio">Fecha Inicio:</label>
          <input 
            type="date" 
            id="fechaInicio" 
            [(ngModel)]="filtros.fechaInicio" 
            name="fechaInicio"
          >
        </div>

        <div class="form-group">
          <label for="fechaFin">Fecha Fin:</label>
          <input 
            type="date" 
            id="fechaFin" 
            [(ngModel)]="filtros.fechaFin" 
            name="fechaFin"
          >
        </div>

        <div class="form-group">
          <label for="tipoReporte">Tipo de Reporte:</label>
          <select 
            id="tipoReporte" 
            [(ngModel)]="filtros.tipoReporte" 
            name="tipoReporte"
          >
            <option *ngFor="let tipo of tiposReporte" [value]="tipo.valor">
              {{tipo.texto}}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="usuario">Usuario:</label>
          <input 
            type="text" 
            id="usuario" 
            [(ngModel)]="filtros.usuario" 
            name="usuario"
            placeholder="Buscar por usuario"
          >
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select 
            id="estado" 
            [(ngModel)]="filtros.estado" 
            name="estado"
          >
            <option *ngFor="let estado of estados" [value]="estado.valor">
              {{estado.texto}}
            </option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-buscar" [disabled]="estaCargando">üîç {{ estaCargando ? 'Buscando...' : 'Buscar' }}</button>
        <button type="button" class="btn-limpiar" (click)="limpiarFiltros()">üßπ Limpiar</button>
        <button type="button" class="btn-exportar" (click)="exportar()">üì§ Exportar</button>
      </div>
    </form>
  </div>

  <!-- Tabla de resultados -->
  <div class="resultados-section">
    <h2>üìã Resultados del Reporte</h2>
    <p class="resumen-busqueda" *ngIf="ultimaBusqueda">
      √öltima consulta filtrada por 
      <span *ngIf="ultimaBusqueda.tipoReporte">tipo <strong>{{ ultimaBusqueda.tipoReporte }}</strong></span>
      <span *ngIf="ultimaBusqueda.usuario"> usuario <strong>{{ ultimaBusqueda.usuario }}</strong></span>
      <span *ngIf="ultimaBusqueda.estado">
        estado 
        <strong>{{ ultimaBusqueda.estado === '1' ? 'Activo' : 'Inactivo' }}</strong>
      </span>
      <span *ngIf="!ultimaBusqueda.tipoReporte && !ultimaBusqueda.usuario && !ultimaBusqueda.estado">criterios generales</span>.
    </p>
    <div class="tabla-container">
      <table class="tabla-reportes" *ngIf="datosPaginados.length; else sinResultados">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Descripci√≥n</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Usuario</th>
            <th>Tipo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of datosPaginados">
            <td>{{item.id}}</td>
            <td>{{item.fecha}}</td>
            <td>{{item.descripcion}}</td>
            <td>${{item.monto | number}}</td>
            <td>
              <span class="estado-badge" [class.activo]="item.estado === 'Activo'" 
                    [class.inactivo]="item.estado === 'Inactivo'">
                {{item.estado}}
              </span>
            </td>
            <td>{{item.usuario}}</td>
            <td>{{item.tipo | titlecase}}</td>
            <td>
              <button class="btn-ver">üëÅÔ∏è Ver</button>
              <button class="btn-editar">‚úèÔ∏è Editar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Informaci√≥n de paginaci√≥n -->
    <ng-template #sinResultados>
      <div class="sin-resultados">
        <p>No se encontraron reportes con los filtros seleccionados.</p>
        <button type="button" (click)="limpiarFiltros()">Restablecer filtros</button>
      </div>
    </ng-template>

    <div class="paginacion-info">
      <p>Mostrando {{ datosPaginados.length }} de {{ totalResultados }} registros</p>
      <div class="paginacion-controls">
        <button class="btn-pagina" (click)="cambiarPagina('prev')" [disabled]="paginaActual === 1">¬´ Anterior</button>
        <span class="pagina-actual">P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
        <button class="btn-pagina" (click)="cambiarPagina('next')" [disabled]="paginaActual === totalPaginas">Siguiente ¬ª</button>
      </div>
    </div>
  </div>
</div>

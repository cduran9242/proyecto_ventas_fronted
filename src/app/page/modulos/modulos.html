<div class="modulos-page">
  <section class="page-header">
    <div class="page-title">
      <h1>Gesti√≥n de M√≥dulos</h1>
      <p>
        Administra los m√≥dulos disponibles en el sistema. Desde aqu√≠ puedes crear nuevos m√≥dulos,
        actualizar la informaci√≥n existente o eliminar los que ya no sean necesarios.
      </p>
    </div>
    <div class="header-stats">
      <div class="stat-card">
        <span class="stat-label">Total m√≥dulos</span>
        <span class="stat-value">{{ modulos.length }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">En edici√≥n</span>
        <span class="stat-value">{{ modoEdicion ? 1 : 0 }}</span>
      </div>
    </div>
  </section>

  <section class="form-section">
    <div class="form-card">
      <div class="form-header">
        <h2>{{ modoEdicion ? 'Editar m√≥dulo' : 'Registrar nuevo m√≥dulo' }}</h2>
        <p class="form-subtitle">
          Completa los datos para {{ modoEdicion ? 'actualizar' : 'crear' }} un m√≥dulo. Todos los campos son obligatorios.
        </p>
        <p class="form-warning" *ngIf="!permiteCrear && !permiteEditar">
          Este rol solo puede visualizar la informaci√≥n de m√≥dulos; el formulario est√° bloqueado.
        </p>
      </div>

      <form [formGroup]="moduloForm" (ngSubmit)="guardarModulo()">
        <div class="form-grid">
          <div class="form-field">
            <label for="nombre">Nombre</label>
            <input
              id="nombre"
              type="text"
              placeholder="Ej: Gesti√≥n de usuarios"
              formControlName="nombre"
              [class.invalid]="nombre?.invalid && (nombre?.dirty || nombre?.touched)"
            />
            <small *ngIf="nombre?.errors?.['required'] && (nombre?.dirty || nombre?.touched)">
              El nombre es obligatorio.
            </small>
            <small *ngIf="nombre?.errors?.['maxlength'] && (nombre?.dirty || nombre?.touched)">
              M√°ximo 80 caracteres.
            </small>
          </div>

          <div class="form-field">
            <label for="ruta">Ruta</label>
            <input
              id="ruta"
              type="text"
              placeholder="Ej: /usuario"
              formControlName="ruta"
              [class.invalid]="ruta?.invalid && (ruta?.dirty || ruta?.touched)"
            />
            <small *ngIf="ruta?.errors?.['required'] && (ruta?.dirty || ruta?.touched)">
              La ruta es obligatoria.
            </small>
            <small *ngIf="ruta?.errors?.['maxlength'] && (ruta?.dirty || ruta?.touched)">
              M√°ximo 120 caracteres.
            </small>
          </div>

          <div class="form-field form-field-full">
            <label for="descripcion">Descripci√≥n</label>
            <textarea
              id="descripcion"
              placeholder="Describe el objetivo del m√≥dulo en el sistema"
              formControlName="descripcion"
              rows="3"
              [class.invalid]="descripcion?.invalid && (descripcion?.dirty || descripcion?.touched)"
            ></textarea>
            <small *ngIf="descripcion?.errors?.['required'] && (descripcion?.dirty || descripcion?.touched)">
              La descripci√≥n es obligatoria.
            </small>
            <small *ngIf="descripcion?.errors?.['maxlength'] && (descripcion?.dirty || descripcion?.touched)">
              M√°ximo 255 caracteres.
            </small>
          </div>

          <div class="form-field">
            <label for="estado">Estado</label>
            <select
              id="estado"
              formControlName="estado"
              [class.invalid]="estado?.invalid && (estado?.dirty || estado?.touched)"
            >
              <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                {{ estado.texto }}
              </option>
            </select>
            <small *ngIf="estado?.errors?.['required'] && (estado?.dirty || estado?.touched)">
              Selecciona una opci√≥n.
            </small>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary" [disabled]="cargando || (!permiteCrear && !permiteEditar)">
            {{ modoEdicion ? 'Actualizar m√≥dulo' : 'Crear m√≥dulo' }}
          </button>
          <button
            type="button"
            class="btn secondary"
            (click)="modoEdicion ? cancelarEdicion() : resetFormulario()"
            [disabled]="cargando || (!permiteCrear && !permiteEditar)"
          >
            {{ modoEdicion ? 'Cancelar edici√≥n' : 'Limpiar formulario' }}
          </button>
        </div>
      </form>

      <div class="feedback">
        <div class="alert success" *ngIf="mensajeExito">{{ mensajeExito }}</div>
        <div class="alert error" *ngIf="mensajeError">{{ mensajeError }}</div>
      </div>
    </div>
  </section>

  <section class="table-section">
    <div class="table-card">
      <div class="table-header">
        <h2>Listado de m√≥dulos</h2>
        <button class="btn ghost" type="button" (click)="cargarModulos()" [disabled]="cargando">
          <span class="icon">‚ü≥</span>
          Actualizar lista
        </button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Ruta</th>
              <th>Estado</th>
              <th>Creado</th>
              <th>Actualizado</th>
              <th class="actions-column">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargando">
              <td colspan="7" class="loading-row">Cargando informaci√≥n...</td>
            </tr>

            <tr *ngIf="!cargando && modulos.length === 0">
              <td colspan="7" class="empty-row">No hay m√≥dulos registrados a√∫n.</td>
            </tr>

            <tr *ngFor="let modulo of modulos">
              <td data-title="ID">{{ modulo.id }}</td>
              <td data-title="Nombre">
                <div class="cell-title">{{ modulo.nombre }}</div>
                <div class="cell-description">{{ modulo.descripcion }}</div>
              </td>
              <td data-title="Ruta">
                <code>{{ modulo.ruta }}</code>
              </td>
              <td data-title="Estado">
                <span class="badge" [class.badge-success]="modulo.estado === 'Activo'" [class.badge-warning]="modulo.estado !== 'Activo'">
                  {{ modulo.estado }}
                </span>
              </td>
              <td data-title="Creado">
                {{ modulo.created_at ? (modulo.created_at | date : 'short') : '‚Äî' }}
              </td>
              <td data-title="Actualizado">
                {{ modulo.updated_at ? (modulo.updated_at | date : 'short') : '‚Äî' }}
              </td>
              <td class="actions-column">
                <button type="button" class="btn small ghost" (click)="editarModulo(modulo)" *ngIf="permiteEditar">
                  ‚úèÔ∏è Editar
                </button>
                <button type="button" class="btn small danger" (click)="confirmarEliminar(modulo)" *ngIf="permiteEliminar">
                  üóëÔ∏è Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>


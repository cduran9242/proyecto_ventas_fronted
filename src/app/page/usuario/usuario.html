<div class="usuario-container">
  <div class="usuario-header">
    <h1>üë• Gesti√≥n de Usuarios</h1>
    <p>Administra todos los usuarios del sistema con sus roles y permisos</p>
  </div>

  <!-- Formulario de nuevo usuario -->
  <div class="nuevo-usuario-section">
    <h2>{{ modoEdicion ? '‚úèÔ∏è Editar Usuario' : '‚ûï Nuevo Usuario' }}</h2>
    <form class="usuario-form" [formGroup]="usuarioForm" (ngSubmit)="guardarUsuario()">
      <div class="form-grid">
        <div class="form-group">
          <label for="nombres">Nombres:</label>
          <input 
            type="text" 
            id="nombres"
            placeholder="Nombres completos"
            formControlName="nombres"
            [class.error]="nombres?.invalid && (nombres?.dirty || nombres?.touched)"
          >
          <small *ngIf="nombres?.hasError('required') && (nombres?.dirty || nombres?.touched)">
            Los nombres son obligatorios.
          </small>
          <small *ngIf="nombres?.hasError('maxlength') && (nombres?.dirty || nombres?.touched)">
            M√°ximo 120 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="apellidos">Apellidos:</label>
          <input 
            type="text" 
            id="apellidos"
            placeholder="Apellidos del usuario"
            formControlName="apellidos"
            [class.error]="apellidos?.invalid && (apellidos?.dirty || apellidos?.touched)"
          >
          <small *ngIf="apellidos?.hasError('required') && (apellidos?.dirty || apellidos?.touched)">
            Los apellidos son obligatorios.
          </small>
          <small *ngIf="apellidos?.hasError('maxlength') && (apellidos?.dirty || apellidos?.touched)">
            M√°ximo 120 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input 
            type="email" 
            id="email" 
            placeholder="correo@ejemplo.com"
            formControlName="email"
            [class.error]="email?.invalid && (email?.dirty || email?.touched)"
          >
          <small *ngIf="email?.hasError('required') && (email?.dirty || email?.touched)">
            El correo es obligatorio.
          </small>
          <small *ngIf="email?.hasError('email') && (email?.dirty || email?.touched)">
            Ingresa un correo v√°lido.
          </small>
        </div>

        <div class="form-group">
          <label for="telefono">Tel√©fono:</label>
          <input 
            type="tel" 
            id="telefono" 
            placeholder="3001234567"
            formControlName="telefono"
            [class.error]="telefono?.invalid && (telefono?.dirty || telefono?.touched)"
          >
          <small *ngIf="telefono?.hasError('required') && (telefono?.dirty || telefono?.touched)">
            El tel√©fono es obligatorio.
          </small>
        </div>

        <div class="form-group">
          <label for="cedula">C√©dula:</label>
          <input 
            type="text"
            id="cedula"
            placeholder="Documento de identidad"
            formControlName="cedula"
            [class.error]="cedula?.invalid && (cedula?.dirty || cedula?.touched)"
          >
          <small *ngIf="cedula?.hasError('required') && (cedula?.dirty || cedula?.touched)">
            La c√©dula es obligatoria.
          </small>
        </div>

        <div class="form-group">
          <label for="contrasena">Contrase√±a:</label>
          <input
            type="password"
            id="contrasena"
            placeholder="Contrase√±a temporal"
            formControlName="contrasena"
            [class.error]="contrasena?.invalid && (contrasena?.dirty || contrasena?.touched)"
          >
          <small *ngIf="contrasena?.hasError('required') && (contrasena?.dirty || contrasena?.touched)">
            La contrase√±a es obligatoria.
          </small>
          <small *ngIf="contrasena?.hasError('minlength') && (contrasena?.dirty || contrasena?.touched)">
            Debe tener al menos 6 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="rol_id">Rol:</label>
          <select 
            id="rol_id"
            formControlName="rol_id"
            [class.error]="rol_id?.invalid && (rol_id?.dirty || rol_id?.touched)"
          >
            <option value="" disabled>Seleccione un rol</option>
            <option *ngFor="let rol of roles" [value]="rol.id">
              {{rol.nombre}}
            </option>
          </select>
          <small *ngIf="rol_id?.hasError('required') && (rol_id?.dirty || rol_id?.touched)">
            El rol es obligatorio.
          </small>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select
            id="estado"
            formControlName="estado"
            [class.error]="estado?.invalid && (estado?.dirty || estado?.touched)"
          >
            <option *ngFor="let estadoOption of estados" [value]="estadoOption.valor">
              {{estadoOption.texto}}
            </option>
          </select>
          <small *ngIf="estado?.hasError('required') && (estado?.dirty || estado?.touched)">
            Selecciona un estado.
          </small>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-crear" [disabled]="cargando">
          {{ modoEdicion ? 'üíæ Guardar cambios' : '‚úÖ Crear Usuario' }}
        </button>
        <button type="button" class="btn-limpiar" (click)="modoEdicion ? cancelarEdicion() : resetFormulario()" [disabled]="cargando">
          {{ modoEdicion ? '‚Ü©Ô∏è Cancelar edici√≥n' : 'üßπ Limpiar' }}
        </button>
      </div>
    </form>

    <div class="feedback">
      <div class="alert success" *ngIf="mensajeExito">{{ mensajeExito }}</div>
      <div class="alert error" *ngIf="mensajeError">{{ mensajeError }}</div>
    </div>
  </div>

  <!-- Lista de usuarios -->
  <div class="usuarios-lista-section">
    <h2>üìã Lista de Usuarios</h2>

    <div class="tabla-toolbar">
      <button class="btn-refrescar" type="button" (click)="cargarUsuarios()" [disabled]="cargando">
        üîÑ Actualizar
      </button>
    </div>

    <div class="tabla-container">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre Completo</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>C√©dula</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Fecha Creaci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="cargando">
            <td colspan="9" class="loading-row">Cargando usuarios...</td>
          </tr>
          <tr *ngIf="!cargando && usuarios.length === 0">
            <td colspan="9" class="empty-row">No hay usuarios registrados.</td>
          </tr>
          <tr *ngFor="let usuario of usuarios">
            <td>{{usuario.id}}</td>
            <td>{{usuario.nombres}} {{usuario.apellidos}}</td>
            <td>{{usuario.email}}</td>
            <td>{{usuario.telefono}}</td>
            <td>{{usuario.cedula}}</td>
            <td>
              <span class="rol-badge" 
                    [class.admin]="obtenerNombreRol(usuario.rol_id) === 'Administrador'"
                    [class.vendedor]="obtenerNombreRol(usuario.rol_id) === 'Operador'"
                    [class.cliente]="obtenerNombreRol(usuario.rol_id) === 'Auditor'">
                {{obtenerNombreRol(usuario.rol_id)}}
              </span>
            </td>
            <td>
              <span class="estado-badge" 
                    [class.activo]="usuario.estado === 'Activo'"
                    [class.inactivo]="usuario.estado === 'Inactivo'">
                {{usuario.estado}}
              </span>
            </td>
            <td>{{usuario.created_at | date:'short'}}</td>
            <td>
              <button class="btn-editar" (click)="editarUsuario(usuario)">‚úèÔ∏è Editar</button>
              <button class="btn-eliminar" (click)="eliminarUsuario(usuario)">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

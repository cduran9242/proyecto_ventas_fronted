<div class="usuario-container">
  <div class="usuario-header">
    <h1>üë• Gesti√≥n de Usuarios</h1>
    <p>Administra todos los usuarios del sistema con sus roles y permisos</p>
  </div>

  <!-- Formulario de nuevo usuario -->
  <div class="nuevo-usuario-section">
    <h2>{{ modoEdicion ? '‚úèÔ∏è Editar Usuario' : '‚ûï Nuevo Usuario' }}</h2>
    <p class="notice" *ngIf="!permiteCrear && !permiteEditar">
      Este rol s√≥lo tiene permiso de lectura. Los campos est√°n bloqueados.
    </p>
    <form class="usuario-form" [formGroup]="usuarioForm" (ngSubmit)="guardarUsuario()">
      <div class="form-grid">
        <div class="form-group">
          <label for="nombres">Nombres:</label>
          <input 
            type="text" 
            id="nombres"
            placeholder="Nombres completos"
            formControlName="nombres"
            [class.error]="nombres?.invalid && (nombres?.dirty || nombres?.touched)"
          >
          <small *ngIf="nombres?.hasError('required') && (nombres?.dirty || nombres?.touched)">
            Los nombres son obligatorios.
          </small>
          <small *ngIf="nombres?.hasError('maxlength') && (nombres?.dirty || nombres?.touched)">
            M√°ximo 120 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="apellidos">Apellidos:</label>
          <input 
            type="text" 
            id="apellidos"
            placeholder="Apellidos del usuario"
            formControlName="apellidos"
            [class.error]="apellidos?.invalid && (apellidos?.dirty || apellidos?.touched)"
          >
          <small *ngIf="apellidos?.hasError('required') && (apellidos?.dirty || apellidos?.touched)">
            Los apellidos son obligatorios.
          </small>
          <small *ngIf="apellidos?.hasError('maxlength') && (apellidos?.dirty || apellidos?.touched)">
            M√°ximo 120 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input 
            type="email" 
            id="email" 
            placeholder="correo@ejemplo.com"
            formControlName="email"
            [class.error]="email?.invalid && (email?.dirty || email?.touched)"
          >
          <small *ngIf="email?.hasError('required') && (email?.dirty || email?.touched)">
            El correo es obligatorio.
          </small>
          <small *ngIf="email?.hasError('email') && (email?.dirty || email?.touched)">
            Ingresa un correo v√°lido.
          </small>
        </div>

        <div class="form-group">
          <label for="telefono">Tel√©fono:</label>
          <input 
            type="tel" 
            id="telefono" 
            placeholder="3001234567"
            formControlName="telefono"
            [class.error]="telefono?.invalid && (telefono?.dirty || telefono?.touched)"
          >
          <small *ngIf="telefono?.hasError('required') && (telefono?.dirty || telefono?.touched)">
            El tel√©fono es obligatorio.
          </small>
        </div>

        <div class="form-group">
          <label for="cedula">C√©dula:</label>
          <input 
            type="text"
            id="cedula"
            placeholder="Documento de identidad"
            formControlName="cedula"
            [class.error]="cedula?.invalid && (cedula?.dirty || cedula?.touched)"
          >
          <small *ngIf="cedula?.hasError('required') && (cedula?.dirty || cedula?.touched)">
            La c√©dula es obligatoria.
          </small>
        </div>

        <div class="form-group">
          <label for="contrasena">Contrase√±a:</label>
          <input
            type="password"
            id="contrasena"
            placeholder="Contrase√±a temporal"
            formControlName="contrasena"
            [class.error]="contrasena?.invalid && (contrasena?.dirty || contrasena?.touched)"
          >
          <small class="hint" *ngIf="!modoEdicion">
            Ingresa una contrase√±a temporal para el nuevo usuario.
          </small>
          <small class="hint" *ngIf="modoEdicion">
            Deja este campo en blanco si no deseas cambiar la contrase√±a.
          </small>
          <small *ngIf="contrasena?.hasError('required') && (contrasena?.dirty || contrasena?.touched)">
            La contrase√±a es obligatoria al crear un usuario.
          </small>
          <small *ngIf="contrasena?.hasError('minlength') && (contrasena?.dirty || contrasena?.touched)">
            Debe tener al menos 6 caracteres.
          </small>
        </div>

        <div class="form-group">
          <label for="rol_id">Rol:</label>
          <select 
            id="rol_id"
            formControlName="rol_id"
            [class.error]="rol_id?.invalid && (rol_id?.dirty || rol_id?.touched)"
          >
            <option value="" disabled>Seleccione un rol</option>
            <option *ngFor="let rol of roles" [value]="rol.id">
              {{rol.nombre}}
            </option>
          </select>
          <small *ngIf="rol_id?.hasError('required') && (rol_id?.dirty || rol_id?.touched)">
            El rol es obligatorio.
          </small>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select
            id="estado"
            formControlName="estado"
            [class.error]="estado?.invalid && (estado?.dirty || estado?.touched)"
          >
            <option *ngFor="let estadoOption of estados" [value]="estadoOption.valor">
              {{estadoOption.texto}}
            </option>
          </select>
          <small *ngIf="estado?.hasError('required') && (estado?.dirty || estado?.touched)">
            Selecciona un estado.
          </small>
        </div>

        <div class="form-group">
          <label for="departamento">Departamento:</label>
          <select 
            id="departamento"
            formControlName="departamento_id"
            (change)="onDepartamentoChange($any($event.target).value ? +$any($event.target).value : null)"
            [disabled]="cargandoUbicaciones"
          >
            <option value="">Seleccionar departamento (opcional)</option>
            <option *ngFor="let dept of departamentos" [value]="dept.id">
              {{ dept.nombre }}
            </option>
          </select>
          <small *ngIf="cargandoUbicaciones" class="hint">
            Cargando departamentos...
          </small>
        </div>

        <div class="form-group">
          <label for="ciudad">Ciudad:</label>
          <select 
            id="ciudad"
            formControlName="ciudad_id"
            [disabled]="!departamentoSeleccionado || ciudades.length === 0 || cargandoUbicaciones"
          >
            <option value="">Seleccionar ciudad (opcional)</option>
            <option *ngFor="let ciudad of ciudades" [value]="ciudad.id">
              {{ ciudad.nombre }}
            </option>
          </select>
          <small *ngIf="!departamentoSeleccionado" class="hint">
            Primero selecciona un departamento
          </small>
          <small *ngIf="departamentoSeleccionado && ciudades.length === 0 && !cargandoUbicaciones" class="hint">
            No hay ciudades disponibles para este departamento
          </small>
          <small *ngIf="cargandoUbicaciones && departamentoSeleccionado" class="hint">
            Cargando ciudades...
          </small>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-crear" [disabled]="cargando || (!permiteCrear && !permiteEditar)">
          {{ modoEdicion ? 'üíæ Guardar cambios' : '‚úÖ Crear Usuario' }}
        </button>
        <button
          type="button"
          class="btn-limpiar"
          (click)="modoEdicion ? cancelarEdicion() : resetFormulario()"
          [disabled]="cargando || (!permiteCrear && !permiteEditar)"
        >
          {{ modoEdicion ? '‚Ü©Ô∏è Cancelar edici√≥n' : 'üßπ Limpiar' }}
        </button>
      </div>
    </form>

    <div class="feedback">
      <div class="alert success" *ngIf="mensajeExito">{{ mensajeExito }}</div>
      <div class="alert error" *ngIf="mensajeError">{{ mensajeError }}</div>
    </div>
  </div>

  <!-- Lista de usuarios -->
  <div class="usuarios-lista-section">
    <div class="lista-header">
      <div>
        <h2>üìã Lista de Usuarios</h2>
        <p *ngIf="usuariosFiltrados.length !== usuarios.length" class="filtros-activos">
          Mostrando {{ usuariosFiltrados.length }} de {{ usuarios.length }} usuarios
        </p>
      </div>
      <div class="header-actions">
        <button class="btn-refrescar" type="button" (click)="cargarUsuarios()" [disabled]="cargando">
          üîÑ {{ cargando ? 'Cargando...' : 'Actualizar' }}
        </button>
        <button type="button" class="btn-exportar" (click)="exportarCSV()" [disabled]="usuariosFiltrados.length === 0">
          üì§ Exportar CSV
        </button>
      </div>
    </div>

    <!-- Filtros y b√∫squeda -->
    <div class="filtros-section">
      <div class="filtros-grid">
        <div class="filtro-group">
          <label for="busqueda">üîç B√∫squeda:</label>
          <input 
            type="text" 
            id="busqueda"
            [(ngModel)]="busquedaTexto"
            (ngModelChange)="aplicarFiltros()"
            placeholder="Buscar por nombre, email, c√©dula..."
            class="input-busqueda"
          >
        </div>

        <div class="filtro-group">
          <label for="filtroRol">üë§ Rol:</label>
          <select 
            id="filtroRol"
            [(ngModel)]="filtroRol"
            (ngModelChange)="aplicarFiltros()"
            class="select-filtro"
          >
            <option value="">Todos los roles</option>
            <option *ngFor="let rol of roles" [value]="rol.id.toString()">
              {{ rol.nombre }}
            </option>
          </select>
        </div>

        <div class="filtro-group">
          <label for="filtroEstado">‚ö° Estado:</label>
          <select 
            id="filtroEstado"
            [(ngModel)]="filtroEstado"
            (ngModelChange)="aplicarFiltros()"
            class="select-filtro"
          >
            <option value="">Todos los estados</option>
            <option *ngFor="let estado of estados" [value]="estado.valor">
              {{ estado.texto }}
            </option>
          </select>
        </div>

        <div class="filtro-group">
          <button type="button" class="btn-limpiar-filtros" (click)="limpiarFiltros()">
            üßπ Limpiar filtros
          </button>
        </div>
      </div>
    </div>

    <div class="tabla-container">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th (click)="ordenarPor('id')" class="sortable">
              ID
              <span *ngIf="ordenColumna === 'id'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('nombres')" class="sortable">
              Nombre Completo
              <span *ngIf="ordenColumna === 'nombres'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('email')" class="sortable">
              Email
              <span *ngIf="ordenColumna === 'email'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Tel√©fono</th>
            <th>C√©dula</th>
            <th (click)="ordenarPor('rol')" class="sortable">
              Rol
              <span *ngIf="ordenColumna === 'rol'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Departamento</th>
            <th>Ciudad</th>
            <th (click)="ordenarPor('estado')" class="sortable">
              Estado
              <span *ngIf="ordenColumna === 'estado'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('created_at')" class="sortable">
              Fecha Creaci√≥n
              <span *ngIf="ordenColumna === 'created_at'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="cargando">
            <td colspan="11" class="loading-row">
              <span>‚è≥ Cargando usuarios...</span>
            </td>
          </tr>
          <tr *ngIf="!cargando && usuarios.length === 0">
            <td colspan="11" class="empty-row">
              <span>üì≠ No hay usuarios registrados todav√≠a.</span>
              <p style="font-size: 0.9rem; margin-top: 8px; color: #94a3b8;">Crea tu primer usuario usando el formulario de arriba.</p>
            </td>
          </tr>
          <tr *ngIf="!cargando && usuarios.length > 0 && usuariosFiltrados.length === 0">
            <td colspan="11" class="empty-row">
              <span>üîç No se encontraron usuarios con los filtros seleccionados.</span>
              <button type="button" class="btn-limpiar-filtros" (click)="limpiarFiltros()" style="margin-top: 10px;">Limpiar filtros</button>
            </td>
          </tr>
          <tr *ngFor="let usuario of usuariosPaginados">
            <td>{{usuario.id}}</td>
            <td>{{usuario.nombres}} {{usuario.apellidos}}</td>
            <td>{{usuario.email}}</td>
            <td>{{usuario.telefono}}</td>
            <td>{{usuario.cedula}}</td>
            <td>
              <span class="rol-badge" 
                    [class.admin]="obtenerNombreRol(usuario.rol_id) === 'Administrador'"
                    [class.vendedor]="obtenerNombreRol(usuario.rol_id) === 'Operador'"
                    [class.cliente]="obtenerNombreRol(usuario.rol_id) === 'Auditor'">
                {{obtenerNombreRol(usuario.rol_id)}}
              </span>
            </td>
            <td>
              <span class="ubicacion-badge">
                {{obtenerNombreDepartamento(usuario.departamento_id)}}
              </span>
            </td>
            <td>
              <span class="ubicacion-badge">
                {{obtenerNombreCiudad(usuario.ciudad_id)}}
              </span>
            </td>
            <td>
              <span class="estado-badge" 
                    [class.activo]="usuario.estado === 'Activo'"
                    [class.inactivo]="usuario.estado === 'Inactivo'">
                {{usuario.estado}}
              </span>
            </td>
            <td>{{usuario.created_at | date:'short'}}</td>
            <td>
              <button class="btn-editar" (click)="editarUsuario(usuario)" *ngIf="permiteEditar">‚úèÔ∏è Editar</button>
              <button class="btn-eliminar" (click)="eliminarUsuario(usuario)" *ngIf="permiteEliminar">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div class="paginacion-container" *ngIf="totalPaginas > 1">
        <div class="paginacion-info">
          <p>Mostrando {{ usuariosPaginados.length }} de {{ usuariosFiltrados.length }} usuarios</p>
        </div>
        <div class="paginacion-controls">
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('prev')" 
            [disabled]="paginaActual === 1"
          >
            ¬´ Anterior
          </button>
          <div class="paginas-numeros">
            <button
              *ngFor="let pagina of [].constructor(totalPaginas); let i = index"
              type="button"
              class="btn-pagina-numero"
              [class.active]="paginaActual === i + 1"
              (click)="cambiarPagina(i + 1)"
            >
              {{ i + 1 }}
            </button>
          </div>
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('next')" 
            [disabled]="paginaActual === totalPaginas"
          >
            Siguiente ¬ª
          </button>
        </div>
        <div class="paginacion-info">
          <p>P√°gina {{ paginaActual }} de {{ totalPaginas }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

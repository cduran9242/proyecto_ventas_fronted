<div class="productos-page">
  <header class="productos-header">
    <div>
      <h1>üì¶ Gesti√≥n de Productos</h1>
      <p>Administra el cat√°logo y sus dimensiones asociadas.</p>
    </div>
    <div class="productos-meta">
      <label class="busqueda-label">
        <span>Buscar</span>
        <input
          type="search"
          placeholder="C√≥digo, nombre o categor√≠a"
          [formControl]="busquedaControl"
        >
      </label>
    </div>
  </header>

  <section class="alertas" *ngIf="mensajeError || mensajeExito">
    <div class="alerta error" *ngIf="mensajeError">{{ mensajeError }}</div>
    <div class="alerta exito" *ngIf="mensajeExito">{{ mensajeExito }}</div>
  </section>

  <section class="producto-form-card" [formGroup]="productoForm">
    <div class="form-header">
      <h2>{{ modoEdicion ? '‚úèÔ∏è Editar producto' : '‚ûï Nuevo producto' }}</h2>
      <span class="badge" [class.editando]="modoEdicion">{{ modoEdicion ? 'Edici√≥n' : 'Registro' }}</span>
    </div>

    <form (ngSubmit)="guardarProducto()">
      <div class="form-grid">
        <label class="form-field">
          <span>C√≥digo</span>
          <div class="codigo-wrapper">
            <input type="text" formControlName="codigo_producto" placeholder="C√≥digo √∫nico">
            <button type="button" class="btn-mini" (click)="generarCodigo()" [disabled]="productoForm.disabled">Generar</button>
          </div>
          <small class="error" *ngIf="codigoControl?.invalid && codigoControl?.touched">Requerido.</small>
        </label>

        <label class="form-field">
          <span>Nombre</span>
          <input type="text" formControlName="nombre_producto" placeholder="Nombre del producto">
          <small class="error" *ngIf="nombreControl?.invalid && nombreControl?.touched">Requerido.</small>
        </label>

        <label class="form-field">
          <span>Categor√≠a</span>
          <select formControlName="categoria">
            <option value="">Seleccionar</option>
            <option *ngFor="let categoria of categoriasDisponibles" [value]="categoria">{{ categoria }}</option>
          </select>
        </label>

        <label class="form-field">
          <span>Unidad de medida</span>
          <select formControlName="unidad_medida">
            <option value="">Seleccionar</option>
            <option *ngFor="let unidad of unidadesDisponibles" [value]="unidad">{{ unidad }}</option>
          </select>
        </label>

        <label class="form-field">
          <span>Estado</span>
          <select formControlName="estado">
            <option *ngFor="let estado of estadosDisponibles" [value]="estado">{{ estado }}</option>
          </select>
        </label>

        <label class="form-field descripcion">
          <span>Descripci√≥n</span>
          <textarea rows="3" formControlName="descripcion" placeholder="Informaci√≥n adicional"></textarea>
        </label>
      </div>

      <div class="dimensiones-card" formArrayName="dimensiones">
        <div class="dimensiones-header">
          <h3>Dimensiones asociadas</h3>
          <button type="button" class="btn-add" (click)="agregarDimension()" [disabled]="productoForm.disabled">+ Agregar dimensi√≥n</button>
        </div>

        <div class="dimensiones-table-scroll">
          <div class="dimensiones-table">
            <div class="dimension-row" *ngFor="let dimension of dimensiones.controls; let i = index" [formGroupName]="i">
              <span class="linea">{{ i + 1 }}</span>
              <label>
                <span>Ancho</span>
                <input type="number" formControlName="ancho" min="0" step="0.01">
              </label>
              <label>
                <span>Espesor</span>
                <input type="number" formControlName="espesor" min="0" step="0.01">
              </label>
              <label>
                <span>√ò Interno</span>
                <input type="number" formControlName="diametro_interno" min="0" step="0.01">
              </label>
              <label>
                <span>√ò Externo</span>
                <input type="number" formControlName="diametro_externo" min="0" step="0.01">
              </label>
              <button type="button" class="btn-remove" (click)="eliminarDimension(i)" [disabled]="productoForm.disabled">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" [disabled]="productoForm.invalid || cargando">{{ modoEdicion ? 'Guardar cambios' : 'Registrar producto' }}</button>
        <button type="button" class="btn-secondary" (click)="modoEdicion ? cancelarEdicion() : limpiarFormulario()">{{ modoEdicion ? 'Cancelar' : 'Limpiar' }}</button>
      </div>
    </form>
  </section>

  <section class="productos-listado">
    <header>
      <h2>üìã Cat√°logo registrado</h2>
      <span class="badge total">{{ productosFiltrados.length }} registros</span>
    </header>

    <div class="tabla-wrapper" *ngIf="productosFiltrados.length; else sinProductos">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Unidad</th>
            <th>Estado</th>
            <th>Dimensiones</th>
            <th>Creado</th>
            <th class="acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let producto of productosFiltrados">
            <tr>
              <td>{{ producto.codigo_producto }}</td>
              <td>{{ producto.nombre_producto }}</td>
              <td>{{ producto.categoria || '‚Äî' }}</td>
              <td>{{ producto.unidad_medida || '‚Äî' }}</td>
              <td>
                <span class="estado" [class.inactivo]="producto.estado === 'Inactivo'">{{ producto.estado }}</span>
              </td>
              <td>{{ producto.dimensiones?.length || 0 }}</td>
              <td>{{ producto.created_at | date:'short' }}</td>
              <td class="acciones">
                <button type="button" class="btn-icon" (click)="toggleExpansion(producto.id)">
                  {{ productoExpandidoId === producto.id ? 'Ocultar' : 'Ver' }}
                </button>
                <button type="button" class="btn-icon" (click)="editarProducto(producto)" [disabled]="!permiteEditar">‚úèÔ∏è</button>
                <button type="button" class="btn-icon danger" (click)="eliminarProducto(producto)" [disabled]="!permiteEliminar">üóëÔ∏è</button>
              </td>
            </tr>
            <tr *ngIf="productoExpandidoId === producto.id" class="dimension-expandida">
              <td colspan="8">
                <table class="tabla-dimensiones">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Ancho</th>
                      <th>Espesor</th>
                      <th>√ò Interno</th>
                      <th>√ò Externo</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let dimension of producto.dimensiones; let idx = index">
                      <td>{{ idx + 1 }}</td>
                      <td>{{ dimension.ancho | number:'1.2-2' }}</td>
                      <td>{{ dimension.espesor | number:'1.2-2' }}</td>
                      <td>{{ dimension.diametro_interno | number:'1.2-2' }}</td>
                      <td>{{ dimension.diametro_externo | number:'1.2-2' }}</td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <ng-template #sinProductos>
      <p class="sin-datos">No se encontraron productos.</p>
    </ng-template>
  </section>
</div>

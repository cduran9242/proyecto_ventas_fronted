<div class="productos-container">
  <div class="productos-header">
    <h1>üì¶ Gesti√≥n de Productos</h1>
    <p>Administra el cat√°logo de productos e inventario del sistema</p>
  </div>

  <!-- Mensajes de feedback -->
  <div *ngIf="mostrandoMensaje" class="feedback-messages">
    <div *ngIf="mensajeExito" class="alert alert-success">
      ‚úÖ {{ mensajeExito }}
    </div>
    <div *ngIf="mensajeError" class="alert alert-error">
      ‚ùå {{ mensajeError }}
    </div>
  </div>

  <!-- Formulario de nuevo producto -->
  <div class="nuevo-producto-section">
    <h2>{{ editando ? '‚úèÔ∏è Editar Producto' : '‚ûï Nuevo Producto' }}</h2>
    <form class="producto-form" (ngSubmit)="editando ? actualizarProducto() : crearProducto()">
      <div class="form-grid">
        <div class="form-group">
          <label for="codigo_producto">C√≥digo del Producto: <span class="required">*</span></label>
          <div class="codigo-input">
            <input 
              type="text" 
              id="codigo_producto" 
              [(ngModel)]="nuevoProducto.codigo_producto" 
              name="codigo_producto"
              placeholder="Ej: BAC-1045-20"
              required
            >
            <button type="button" class="btn-generar" (click)="generarCodigo()" [disabled]="editando">üîÑ</button>
          </div>
        </div>

        <div class="form-group">
          <label for="nombre_producto">Nombre del Producto: <span class="required">*</span></label>
          <input 
            type="text" 
            id="nombre_producto" 
            [(ngModel)]="nuevoProducto.nombre_producto" 
            name="nombre_producto"
            placeholder="Nombre del producto"
            required
          >
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n:</label>
          <textarea 
            id="descripcion" 
            [(ngModel)]="nuevoProducto.descripcion" 
            name="descripcion"
            placeholder="Descripci√≥n detallada del producto"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="categoria">Categor√≠a:</label>
          <select 
            id="categoria" 
            [(ngModel)]="nuevoProducto.categoria" 
            name="categoria"
            (change)="!editando && generarCodigo()"
          >
            <option *ngFor="let categoria of categorias" [value]="categoria.valor">
              {{categoria.texto}}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="unidad_medida">Unidad de Medida:</label>
          <select 
            id="unidad_medida" 
            [(ngModel)]="nuevoProducto.unidad_medida" 
            name="unidad_medida"
          >
            <option *ngFor="let unidad of unidadesMedida" [value]="unidad.valor">
              {{unidad.texto}}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select 
            id="estado" 
            [(ngModel)]="nuevoProducto.estado" 
            name="estado"
          >
            <option *ngFor="let estado of estados" [value]="estado.valor">
              {{estado.texto}}
            </option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-crear">
          {{ editando ? 'üíæ Actualizar Producto' : '‚úÖ Crear Producto' }}
        </button>
        <button *ngIf="editando" type="button" class="btn-cancelar" (click)="cancelarEdicion()">
          ‚ùå Cancelar
        </button>
        <button type="button" class="btn-limpiar" (click)="limpiarFormulario()">üßπ Limpiar</button>
      </div>
    </form>
  </div>

  <!-- Lista de productos -->
  <div class="productos-lista-section">
    <div class="lista-header">
      <div>
        <h2>üìã Cat√°logo de Productos</h2>
        <p *ngIf="productosFiltrados.length !== productos.length" class="filtros-activos">
          Mostrando {{ productosFiltrados.length }} de {{ productos.length }} productos
        </p>
      </div>
      <div class="header-actions">
        <button type="button" class="btn-refrescar" (click)="cargarProductos()" [disabled]="productosCargando">
          üîÑ {{ productosCargando ? 'Cargando...' : 'Actualizar' }}
        </button>
        <button type="button" class="btn-exportar" (click)="exportarCSV()" [disabled]="productosFiltrados.length === 0">
          üì§ Exportar CSV
        </button>
      </div>
    </div>

    <!-- Filtros y b√∫squeda -->
    <div class="filtros-section">
      <div class="filtros-grid">
        <div class="filtro-group">
          <label for="busqueda">üîç B√∫squeda:</label>
          <input 
            type="text" 
            id="busqueda"
            [(ngModel)]="busquedaTexto"
            (ngModelChange)="aplicarFiltros()"
            placeholder="Buscar por c√≥digo, nombre, descripci√≥n..."
            class="input-busqueda"
          >
        </div>

        <div class="filtro-group">
          <label for="filtroCategoria">üìÅ Categor√≠a:</label>
          <select 
            id="filtroCategoria"
            [(ngModel)]="filtroCategoria"
            (ngModelChange)="aplicarFiltros()"
            class="select-filtro"
          >
            <option value="">Todas las categor√≠as</option>
            <option *ngFor="let cat of categorias.slice(1)" [value]="cat.valor">
              {{ cat.texto }}
            </option>
          </select>
        </div>

        <div class="filtro-group">
          <label for="filtroEstado">‚ö° Estado:</label>
          <select 
            id="filtroEstado"
            [(ngModel)]="filtroEstado"
            (ngModelChange)="aplicarFiltros()"
            class="select-filtro"
          >
            <option value="">Todos los estados</option>
            <option *ngFor="let estado of estados" [value]="estado.valor">
              {{ estado.texto }}
            </option>
          </select>
        </div>

        <div class="filtro-group">
          <button type="button" class="btn-limpiar-filtros" (click)="limpiarFiltros()">
            üßπ Limpiar filtros
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="productosCargando" class="loading-message">
      <p>‚è≥ Cargando productos...</p>
    </div>

    <div *ngIf="!productosCargando && productos.length === 0" class="empty-message">
      <p>üì≠ No hay productos registrados. Crea tu primer producto arriba.</p>
    </div>

    <div *ngIf="!productosCargando && productos.length > 0 && productosFiltrados.length === 0" class="empty-message">
      <p>üîç No se encontraron productos con los filtros seleccionados.</p>
      <button type="button" class="btn-limpiar-filtros" (click)="limpiarFiltros()">Limpiar filtros</button>
    </div>

    <div *ngIf="!productosCargando && productosFiltrados.length > 0" class="tabla-container">
      <table class="tabla-productos">
        <thead>
          <tr>
            <th (click)="ordenarPor('id')" class="sortable">
              ID
              <span *ngIf="ordenColumna === 'id'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('codigo')" class="sortable">
              C√≥digo
              <span *ngIf="ordenColumna === 'codigo'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('nombre')" class="sortable">
              Nombre
              <span *ngIf="ordenColumna === 'nombre'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Descripci√≥n</th>
            <th (click)="ordenarPor('categoria')" class="sortable">
              Categor√≠a
              <span *ngIf="ordenColumna === 'categoria'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Unidad</th>
            <th (click)="ordenarPor('estado')" class="sortable">
              Estado
              <span *ngIf="ordenColumna === 'estado'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th (click)="ordenarPor('created_at')" class="sortable">
              Creado
              <span *ngIf="ordenColumna === 'created_at'" class="sort-icon">
                {{ ordenDireccion === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let producto of productosPaginados" (dblclick)="debugProducto(producto)" title="Doble clic para ver detalles en consola">
            <td>{{producto.id || 'N/A'}}</td>
            <td><code>{{obtenerCodigo(producto)}}</code></td>
            <td>{{obtenerNombre(producto)}}</td>
            <td class="descripcion-cell" title="{{producto.descripcion || 'Sin descripci√≥n'}}">
              {{producto.descripcion || 'Sin descripci√≥n'}}
            </td>
            <td>
              <span class="categoria-badge">{{producto.categoria || 'Sin categor√≠a'}}</span>
            </td>
            <td>{{producto.unidad_medida || 'N/A'}}</td>
            <td>
              <span class="estado-badge" 
                    [class.activo]="producto.estado === 'Activo'"
                    [class.inactivo]="producto.estado === 'Inactivo'"
                    [class.suspendido]="producto.estado === 'Suspendido'"
                    [class.sininfo]="producto.estado === 'Sin info'">
                {{producto.estado || 'Sin estado'}}
              </span>
            </td>
            <td class="fecha-cell">
              <small *ngIf="producto.created_at">{{producto.created_at | date:'short'}}</small>
              <small *ngIf="!producto.created_at">-</small>
            </td>
            <td class="acciones-cell">
              <button class="btn-editar" (click)="editarProducto(producto)" title="Editar">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn-eliminar" (click)="eliminarProducto(producto)" title="Eliminar">
                üóëÔ∏è Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div class="paginacion-container" *ngIf="totalPaginas > 1">
        <div class="paginacion-info">
          <p>Mostrando {{ productosPaginados.length }} de {{ productosFiltrados.length }} productos</p>
        </div>
        <div class="paginacion-controls">
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('prev')" 
            [disabled]="paginaActual === 1"
          >
            ¬´ Anterior
          </button>
          <div class="paginas-numeros">
            <button
              *ngFor="let pagina of [].constructor(totalPaginas); let i = index"
              type="button"
              class="btn-pagina-numero"
              [class.active]="paginaActual === i + 1"
              (click)="cambiarPagina(i + 1)"
            >
              {{ i + 1 }}
            </button>
          </div>
          <button 
            type="button" 
            class="btn-pagina" 
            (click)="cambiarPagina('next')" 
            [disabled]="paginaActual === totalPaginas"
          >
            Siguiente ¬ª
          </button>
        </div>
        <div class="paginacion-info">
          <p>P√°gina {{ paginaActual }} de {{ totalPaginas }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
